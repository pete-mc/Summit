<body>
    <img src="img/logo.png" alt="Summit" />
    <h1>Terrain | Summit</h1>
    <p>Launching Summit Please Wait...</p>
    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript">
        document.addEventListener('deviceready', function() {
            var ref = cordova.InAppBrowser.open('https://terrain.scouts.com.au', '_blank', 'hideurlbar=yes,location=no,toolbar=no,zoom=no,footer=no');
            console.log("deviceready");
            
            ref.addEventListener('exit', function(event) {
                console.log("exit");
                navigator.app.exitApp();
            });

            ref.addEventListener('loadstop', async function(event) {
                console.log("loadstop");
                var url = new URL(event.url);
                console.log(url.origin + url.pathname);
                if (url.origin === 'https://terrain.scouts.com.au') {
                    console.log("Loading Summit");
                    // JavaScript files to inject
                    var jsFiles = [
                       "./bin/summit-bootstrap.js"
                    ];

                    // CSS files to inject
                    var cssFiles = [
                       "./styles/dependencies/datatables.min.css",
                       "./styles/dependencies/flatpickr.min.css",
                       "./styles/summit.css"
                    ];
                    console.log("Loading JS Files");
                    for (let jsFile of jsFiles) {
                        await fetch(jsFile)
                            .then(response => response.text())
                            .then(js => {
                                js += `\n//# sourceURL=TerrainSummit/${jsFile}`;
                                return ref.executeScript({ code: js });
                            })
                            .catch(error => console.log('Error injecting JS file:', error));
                    }
                    console.log("Loading CSS Files");
                    for (let cssFile of cssFiles) {
                        await fetch(cssFile)
                            .then(response => response.text())
                            .then(css => ref.insertCSS({ code: css }))
                            .catch(error => console.log('Error injecting CSS file:', error));
                    }
                    console.log("Loaded Summit, Launching now");
                    navigator.splashscreen.hide();
                }
            });

            ref.addEventListener('loaderror', function(event) {
                console.log('Load error: ' + event.message);
            });

            ref.addEventListener('beforeload', function(params, callback) {
            // Check if the URL is a file URL
            if (params.url.endsWith('.pdf') || params.url.endsWith('.doc') || params.url.endsWith('.docx')|| params.url.endsWith('.xls') || params.url.endsWith('.xlsx')) {
                // Cancel the URL load
                callback({cancel: true});

                // Download the file
                fetch(params.url)
                    .then(response => response.blob())
                    .then(blob => {
                        // Convert the blob to an array buffer
                        var reader = new FileReader();
                        reader.onload = function() {
                            var arrayBuffer = this.result;

                            // Get the filename from the URL
                            var filename = params.url.split('/').pop();

                            // Write the file to the device's file system
                            window.resolveLocalFileSystemURL(cordova.file.externalRootDirectory, function(directoryEntry) {
                                directoryEntry.getFile(filename, { create: true }, function(fileEntry) {
                                    fileEntry.createWriter(function(fileWriter) {
                                        fileWriter.onwriteend = function() {
                                            console.log("File download complete: " + fileEntry.toURL());
                                        };
                                        fileWriter.onerror = function(e) {
                                            console.log("Failed file download: " + e.toString());
                                        };
                                        var dataBlob = new Blob([arrayBuffer], { type: "application/octet-stream" });
                                        fileWriter.write(dataBlob);
                                    });
                                });
                            });
                        };
                        reader.readAsArrayBuffer(blob);
                    });
            } else {
                // Allow the URL to load
                callback();
            }
        });
        });
    </script>
</body>